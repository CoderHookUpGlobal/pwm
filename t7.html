<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>PWM</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /*  * {
      border: dotted !important;
    }    */

    body {
      font-family: Arial, Helvetica, sans-serif;
      background-color: rgb(62, 62, 62);
    }


    #menu {
      display: grid;
      grid-template-columns: 1fr;
      grid-template-rows: .1fr 3fr;
      height: 100%;
      width: 0;
      position: fixed;
      z-index: 1;
      top: 0;
      left: 0;
      background-color: #111;
      overflow-x: hidden;
      transition: 500ms;
    }


    #action {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgb(167, 167, 167) !important;
      z-index: 2;
      cursor: pointer;
    }

    .form {}

    #content {}

    .th {
      text-align: center;
      color: rgb(255, 255, 255);
      border-style: solid;
      border-color: limegreen;
      border-radius: 4px;
      overflow-wrap: break-word;
      height: 2rem;
      line-height: 2rem;
    }

    .title {
      font-weight: bold;
      font-size: 1.5rem;
      color: azure;
      cursor: pointer;
    }

    .title:hover {
      font-weight: bolder;

      color: rgb(0, 0, 0);
      cursor: pointer;
    }

    .hide {
      display: none;
    }


    .link {
      cursor: pointer;
      font-size: 1rem;
      font-weight: bolder;
      color: rgb(39, 81, 144);
      margin: .2rem;
    }

    .link:hover {
      color: rgb(0, 98, 255);
    }

    .right {
      text-align: right;
    }

    .left,
    .right {
      flex: 1;
    }

    .rec {
      color: black !important;
      background-color: rgb(190, 190, 190);
    }

    .rec:hover {
      background-color: rgb(154, 180, 187);
      border-color: rgba(0, 115, 255, 0.822);
    }

    button {
      border-radius: 6px;
      width: 100px;
      height: 35px;
    }

    input[type=text] {
      border-radius: 10px;
      width: 220px;
      height: 30px;
    }

    .no-border {
      border: none !important;
    }

    #actionBar {
      display: flex;
      justify-content: center;
    }

    #grid {
      margin: auto;
      width: 90vw;
    }

    #head {
      display: flex;
    }

    #close {
      text-align: right;
    }

    .closeButton {
      color: rgb(218, 218, 218);
      font-weight: bolder;
      font-size: 1.5rem;
      margin-left: auto;
      padding: 3px;

    }

    .closeButton:hover {
      color: rgb(152, 152, 152);

    }

    #content {
      display: grid;
      padding-top: 50px;
      grid-template-columns: .5fr repeat(4, 1fr);
      grid-gap: .5rem;
    }

    @media screen and (min-width:250px) and (max-width:480px) {

      #content {
        grid-template-columns: repeat(1, 1fr) !important;
      }

      .title {
        font-weight: bold;
        font-size: 1rem;
        color: azure;
      }

      .title:hover {
        font-weight: bolder !important;
        color: rgb(92, 57, 27);
      }

      p.th {
        display: none;
      }

      .rec {
        margin-top: 15px;
      }
    }
  </style>
</head>

<body>

  <div id="menu">
    <div id="close" class="closeButton">X</div>
    <ul id="menuItems">
      <li class="link" id="lvlt">Load Vault</li>
      <li class="link" id="ImportCSV">Import CSV</li>
      <!-- After Load or Import -->
      <li class="link" id="apsw">Add Password</li>
      <li class="link" id="lcvs2">Master Password</li>
      <li class="link" id="lcvs3">Save Vault</li>
    </ul>

  </div>

  <div id="grid">

    <div id="head">
      <div id="open" class="title left">â˜°</div>
      <div class="title center">HookUpGlobal</div>
      <div class="title right">About</div>

    </div>
    <div id="actionBar">
      <div class="no-border"><input type="text"><button>Search</button></div>
    </div>

    <div id="content">
      <div class="th">Name</div>
      <div class="th">Url</div>
      <div class="th">User Name</div>
      <div class="th">Password</div>
      <div class="th">Note</div>
    </div>
  </div>
  </div>


  <div id="action" class="hide">
    <div id="closeAction" class="closeButton">X</div>
    <div id="actionGrid">
      <div class="form hide" id="load">
        <input id="pwf" type="file">
      </div>

      <div class="form hide" id="import">
        <input id="icsvf" type="file">
      </div>

      <div class="form hide" id="addPassword">
        <label for="name" class="form">Name</label>
        <input id="name" type="text" class="text">

        <label for="url" class="form">URL</label>
        <input id="url" type="text" class="text">

        <label for="username" class="form">User Name</label>
        <input id="username" type="text" class="text">


        <label for="username" class="form">Password</label>
        <div>
          <p class="link">Generate</p>
          <input type="text" class="text">
        </div>



        <label for="note" class="form">Note</label>
        <input type="text" class="text" id="note">

      </div>


    </div>
  </div>
</body>
<script>

  (() => {

    const $ = (id) => document.getElementById(id)
    const $id = (id) => document.getElementById(id)
    const $cr = (t, opt) => document.createElement(t, opt)
    const $qs = (q) => document.querySelector(q)

    // Import Vault
    //$("pwf").addEventListener("change", (e) => { console.log(e) })
    // Import CSV


    // Load Vault
    // $("lvlt").addEventListener("click", (e) => { console.log(e) })
    // Load CSV
    // $("lcvs").addEventListener("click", (e) => { console.log(e) })


    $openMenu = () => {
      console.log("Clicked")
      $("menu").style.width = "200px";
      $("grid").style.marginLeft = "200px";

    }
    $("open").addEventListener("click", $openMenu)

    $closeMenu = () => {
      console.log("Clicked")
      $("menu").style.width = "0px";
      $("grid").style.margin = "auto";
    }
    $("close").addEventListener("click", $closeMenu)

    $closeAction = () => {
      $("action").classList.toggle("hide")
      let forms = $("action").querySelectorAll(".form")
      for (let f of forms) {
        f.classList.add("hide")
      }
    }

    $("closeAction").addEventListener("click", $closeAction)
    // Add Password
    $addpass = () => {
      //$("action").classList.toggle("hide");
      //$("addPassword").classList.toggle("hide");
    }
    $("apsw").addEventListener("click", $addpass)

    $importCSV = () => {


      let files = $("icsvf").files
      console.trace();
      if (files.length != 0) {
        let r = new FileReader();
        r.onload = (e) => {
          $parseCsv(e)
        }
        r.onerror = (e) => alert(e.target.error.name)
        r.readAsText(files[0])
      }

    }
    $("ImportCSV").addEventListener("click", () => { toggle({ "action": ["hide"], "import": ["hide"] }) })
    $("icsvf").addEventListener("change", $importCSV)


    // Perlish Helper Function
    // Takes a obj with the key of an id of an element 
    // and a vaule of and an array of classes to toggle.
    // Example: toggle({"elm1":["class1","class2"],elm2":["class1","class2"]})
    function toggle(obj) {
      // Use In because we need the element id.
      for (let id in obj) {
        for (let cls of obj[id]) {
          $(id).classList.toggle(cls)
        }
      }
    }

    function getKeyMaterial() {
      // TODO Create Password Display
      let password = window.prompt("Enter your password");
      let enc = new TextEncoder();
      return window.crypto.subtle.importKey(
        "raw",
        enc.encode(password),
        { name: "PBKDF2" },
        false,
        ["deriveBits", "deriveKey"]
      );
    }

    function getKey(keyMaterial, salt) {
      return window.crypto.subtle.deriveKey(
        {
          "name": "PBKDF2",
          salt: salt,
          "iterations": 1000000,
          "hash": "SHA-256"
        },
        keyMaterial,
        { "name": "AES-GCM", "length": 256 },
        true,
        ["encrypt", "decrypt"]
      );
    }

    function getData() {
      // TODO Get The JSON
      let message = "this is the message => " + Date.now
      let enc = new TextEncoder();
      return enc.encode(message);
    }

    async function encryptF() {

      // Create the Salt and IV
      const salt = window.crypto.getRandomValues(new Uint8Array(16));
      const iv = window.crypto.getRandomValues(new Uint8Array(12));

      // Create the Encryption Key
      let keyMaterial = await getKeyMaterial();
      let key = await getKey(keyMaterial, salt);

      // Encode the Data        
      encrypted_data = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, getData());

      // Prepare the Vault Information
      const valut_data = window.btoa(String.fromCharCode.apply(null, new Uint8Array(encrypted_data)))
      const vault_iv = window.btoa(String.fromCharCode.apply(null, new Uint8Array(iv)))
      const vault_salt = window.btoa(String.fromCharCode.apply(null, salt))
      const vault = JSON.stringify({ "data": valut_data, "iv": vault_iv, "salt": vault_salt })

      // Download the Vault File
      let dfl = $cr('a');
      dfl.href = 'data:attachment/json,' + encodeURI(vault);
      dfl.target = '_blank';
      dfl.download = 'password.vault';
      dfl.click();
    }

    async function decryptF(e) {

      // Decode the Vault File
      let f = decodeF(e.target.result)

      // Create the PBKDF2 Key
      let keyMaterial = await getKeyMaterial();
      let key = await getKey(keyMaterial, f.salt);

      // Decrypt the Vault Data or Report an Error
      try {
        let decrypted = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: f.iv }, key, f.data);
        console.log(String.fromCharCode.apply(null, new Uint8Array(decrypted)));
      } catch (e) {
        console.log(e)
      }
    }

    function decodeF(file) {

      // Parse the Vault File's JSON
      let vjs = JSON.parse(file)

      // Create an Array of the JSON Elements to Decode
      let dc = ["iv", "data", "salt"]

      // Decode
      for (let k of dc) {
        let string = window.atob(vjs[k])
        const buffer = new ArrayBuffer(string.length)
        const bufferView = new Uint8Array(buffer)
        for (let i = 0; i < string.length; i++) {
          bufferView[i] = string.charCodeAt(i)
        }
        vjs[k] = buffer
      }

      return vjs
    }

    function CreateNewPasswordFile() {

      let dfl = document.createElement('a');
      dfl.href = 'data:attachment/text,' + encodeURI('{"Records":[]"Publickey": {}}');
      dfl.target = '_blank';
      dfl.download = 'vault.json';
      dfl.click();

    }





    function loadVault() {
      let files = $id("pwf").files

      if (files.length != 0) {
        let r = new FileReader();
        r.onload = (e) => {
          decryptF(e)
          vault_is_loaded = 1
        }
        r.onerror = (e) => alert(e.target.error.name)
        r.readAsText(files[0])
      }

    }

    $parseCsv = (e) => {
      const $filter = (f) => {
        return m.length != 0
      }
      let records = e.target.result.split(/(?:\r\n|\n)+/).filter($filter);

      let head = lines.splice(0, 1)[0].split(",");


      let fldsRegx = /(?:\"([^\"]*(?:\"\"[^\"]*)*)\")|([^\",]+)/g;
      let elements = [];

      for (let rec of records) {
        let records = {};
          while (flds = fldsRegx.exec(re[i])) {
          let v = flds[1] || flds[2];
          v = v.replace(/\"\"/g, "\"");

          
        }

        elements.push(element);
      }

    }
  })();
</script>

</html>